<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayosha Footwear Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        /* Dashboard Styles */
        .admin-panel {
            display: none;
            min-height: 100vh;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .admin-body {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: #34495e;
            color: white;
            padding: 20px 0;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar li:hover {
            background: #2c3e50;
        }

        .sidebar li.active {
            background: #3498db;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background: #ecf0f1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            color: #3498db;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .size-checkboxes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .size-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::before {
            transform: translateX(30px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter input, .search-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            position: relative;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .admin-body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-offline">
        Checking connection...
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <form class="login-form" id="loginForm">
            <h2>Bayosha Footwear Admin</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn">Login</button>
            <div id="loginError" class="alert alert-error" style="display: none; margin-top: 15px;"></div>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <header class="admin-header">
            <h1>Bayosha Footwear Admin Panel</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="admin-body">
            <nav class="sidebar">
                <ul>
                    <li class="nav-item active" data-section="dashboard">📊 Dashboard</li>
                    <li class="nav-item" data-section="products">👟 Products Management</li>
                    <li class="nav-item" data-section="orders">📦 Orders Management</li>
                    <li class="nav-item" data-section="debug">🔧 Debug Info</li>
                </ul>
            </nav>

            <main class="main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <h2>Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalProducts">0</h3>
                            <p>Total Products</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="ordersToday">0</h3>
                            <p>Orders Today</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingOrders">0</h3>
                            <p>Pending Orders</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalRevenue">₹0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                </div>

                <!-- Products Management Section -->
                <div id="products" class="section">
                    <h2>Products Management</h2>
                    
                    <div class="search-filter">
                        <input type="text" id="productSearch" placeholder="Search products...">
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="men">Men's</option>
                            <option value="women">Women's</option>
                            <option value="children">Children's</option>
                        </select>
                        <button class="btn" onclick="showAddProductForm()">Add New Product</button>
                        <button class="btn" onclick="refreshProducts()">Refresh</button>
                    </div>

                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price (₹)</th>
                                    <th>Stock Status</th>
                                    <th>Sizes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Management Section -->
                <div id="orders" class="section">
                    <h2>Orders Management</h2>
                    
                    <div class="search-filter">
                        <input type="text" id="orderSearch" placeholder="Search orders...">
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn" onclick="refreshOrders()">Refresh</button>
                    </div>

                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Village</th>
                                    <th>Date</th>
                                    <th>Amount (₹)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Debug Section -->
                <div id="debug" class="section">
                    <h2>Debug Information</h2>
                    <div id="debugInfo">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h4>Firebase Connection Test</h4>
                            <button class="btn" onclick="testFirebaseConnection()">Test Connection</button>
                            <div id="connectionResult" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h4>Local Storage Data</h4>
                            <button class="btn" onclick="showLocalStorageData()">Show Local Data</button>
                            <button class="btn" onclick="clearLocalStorageData()">Clear Local Data</button>
                            <div id="localStorageResult" style="margin-top: 10px;"></div>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h4>Add Test Product</h4>
                            <button class="btn" onclick="addTestProduct()">Add Test Product</button>
                            <div id="testProductResult" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addProductModal')">&times;</span>
            <h3>Add New Product</h3>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="productCategory" required>
                            <option value="">Select Category</option>
                            <option value="men">Men's</option>
                            <option value="women">Women's</option>
                            <option value="children">Children's</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Price (₹) *</label>
                        <input type="number" id="productPrice" required min="0" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Available Sizes</label>
                    <div class="size-checkboxes">
                        <div class="size-checkbox">
                            <input type="checkbox" id="size6" value="6">
                            <label for="size6">6</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size7" value="7">
                            <label for="size7">7</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size8" value="8">
                            <label for="size8">8</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size9" value="9">
                            <label for="size9">9</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size10" value="10">
                            <label for="size10">10</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size11" value="11">
                            <label for="size11">11</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size12" value="12">
                            <label for="size12">12</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Stock Status</label>
                    <div class="toggle-switch active" id="stockToggle" onclick="toggleStock()">
                    </div>
                    <span id="stockStatus">In Stock</span>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDescription" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" class="btn">Add Product</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let products = [];
        let orders = [];
        let isOnline = false;

        // Firebase configuration - Updated with correct endpoints
        const FIREBASE_CONFIG = {
            databaseURL: 'https://bayosa-footwear-default-rtdb.asia-southeast1.firebasedatabase.app',
            endpoints: {
                products: '/products',
                orders: '/orders',
                categories: '/categories'
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            setupEventListeners();
            checkConnectionStatus();
            loadInitialData();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    showSection(this.dataset.section);
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search and filters
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);

            // Add product form
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        function checkSession() {
            const rememberedUser = localStorage.getItem('adminUser');
            if (rememberedUser) {
                currentUser = JSON.parse(rememberedUser);
                showAdminPanel();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (username === 'admin' && password === 'bayosha123') {
                currentUser = { username, loginTime: new Date().toISOString() };
                
                if (rememberMe) {
                    localStorage.setItem('adminUser', JSON.stringify(currentUser));
                }
                
                showAdminPanel();
                showAlert('Login successful!', 'success');
            } else {
                showAlert('Invalid credentials!', 'error');
            }
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboardData();
            loadProducts();
            loadOrders();
        }

        function logout() {
            localStorage.removeItem('adminUser');
            currentUser = null;
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '60px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Improved Firebase API functions with better error handling
        async function firebaseRequest(endpoint, method = 'GET', data = null) {
            const url = `${FIREBASE_CONFIG.databaseURL}${endpoint}.json`;
            
            try {
                console.log(`Firebase ${method} request to:`, url);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(url, options);
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Firebase response:', result);
                
                updateConnectionStatus(true);
                return result;
                
            } catch (error) {
                console.error(`Firebase ${method} error:`, error);
                updateConnectionStatus(false);
                
                // Return fallback data for GET requests
                if (method === 'GET') {
                    return getLocalFallbackData(endpoint);
                }
                
                throw error;
            }
        }

        function updateConnectionStatus(online) {
            isOnline = online;
            const statusElement = document.getElementById('connectionStatus');
            
            if (online) {
                statusElement.textContent = 'Online - Connected to Firebase';
                statusElement.className = 'connection-status status-online';
            } else {
                statusElement.textContent = 'Offline - Using Local Storage';
                statusElement.className = 'connection-status status-offline';
            }
        }

        function getLocalFallbackData(endpoint) {
            const key = endpoint.replace('/', '');
            const localData = localStorage.getItem(`bayosha_${key}`);
            
            if (localData) {
                return JSON.parse(localData);
            }
            
            // Return sample data if no local data exists
            if (endpoint === '/products') {
                return {
                    'sample1': {
                        name: 'Classic Black Formal Shoes',
                        category: 'men',
                        price: 2500,
                        sizes: ['7', '8', '9', '10'],
                        inStock: true,
                        description: 'Premium quality black formal shoes for men',
                        createdAt: new Date().toISOString()
                    }
                };
            }
            
            return {};
        }

        async function checkConnectionStatus() {
            try {
                console.log('Testing Firebase connection...');
                await firebaseRequest('/test', 'GET');
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                updateConnectionStatus(false);
            }
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadProducts(),
                    loadOrders()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Error loading data, using offline mode', 'error');
            }
        }

        async function loadProducts() {
            try {
                console.log('Loading products...');
                const data = await firebaseRequest('/products', 'GET');
                
                if (data && typeof data === 'object') {
                    products = Object.entries(data).map(([id, product]) => ({
                        id, 
                        ...product
                    }));
                } else {
                    products = [];
                }
                
                console.log('Products loaded:', products);
                displayProducts();
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
                displayProducts();
            }
        }

        async function loadOrders() {
            try {
                console.log('Loading orders...');
                const data = await firebaseRequest('/orders', 'GET');
                
                if (data && typeof data === 'object') {
                    orders = Object.entries(data).map(([id, order]) => ({
                        id, 
                        ...order
                    }));
                } else {
                    orders = [];
                }
                
                console.log('Orders loaded:', orders);
                displayOrders();
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
                displayOrders();
            }
        }

        function loadDashboardData() {
            updateDashboardStats();
        }

        function updateDashboardStats() {
            const totalProducts = products.length;
            const today = new Date().toDateString();
            const ordersToday = orders.filter(order => 
                new Date(order.date).toDateString() === today
            ).length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const totalRevenue = orders
                .filter(order => order.status === 'delivered')
                .reduce((sum, order) => sum + (order.total || 0), 0);

            // Update DOM
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('ordersToday').textContent = ordersToday;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
        }

        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id.substr(-6)}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>₹${product.price}</td>
                    <td>
                        <div class="toggle-switch ${product.inStock ? 'active' : ''}" 
                             onclick="toggleProductStock('${product.id}')">
                        </div>
                        <span>${product.inStock ? 'In Stock' : 'Out of Stock'}</span>
                    </td>
                    <td>${(product.sizes || []).join(', ')}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteProduct('${product.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>#${order.id.substr(-6)}</td>
                    <td>${order.customerName}</td>
                    <td>${order.village}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>₹${order.total}</td>
                    <td>
                        <select onchange="updateOrderStatus('${order.id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-small btn-view" onclick="viewOrderDetails('${order.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            displayFilteredProducts(filteredProducts);
        }

        function displayFilteredProducts(filteredProducts) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = filteredProducts.map(product => `
                <tr>
                    <td>${product.id.substr(-6)}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>₹${product.price}</td>
                    <td>
                        <div class="toggle-switch ${product.inStock ? 'active' : ''}" 
                             onclick="toggleProductStock('${product.id}')">
                        </div>
                        <span>${product.inStock ? 'In Stock' : 'Out of Stock'}</span>
                    </td>
                    <td>${(product.sizes || []).join(', ')}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteProduct('${product.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddProductForm() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleStock() {
            const toggle = document.getElementById('stockToggle');
            const status = document.getElementById('stockStatus');
            
            if (toggle.classList.contains('active')) {
                toggle.classList.remove('active');
                status.textContent = 'Out of Stock';
            } else {
                toggle.classList.add('active');
                status.textContent = 'In Stock';
            }
        }

        async function handleAddProduct(e) {
            e.preventDefault();
            
            try {
                console.log('Starting product addition...');
                
                const name = document.getElementById('productName').value.trim();
                const category = document.getElementById('productCategory').value;
                const price = parseFloat(document.getElementById('productPrice').value);
                const description = document.getElementById('productDescription').value.trim();
                const inStock = document.getElementById('stockToggle').classList.contains('active');
                
                // Validate required fields
                if (!name) {
                    showAlert('Product name is required!', 'error');
                    return;
                }
                
                if (!category) {
                    showAlert('Please select a category!', 'error');
                    return;
                }
                
                if (!price || price <= 0) {
                    showAlert('Please enter a valid price!', 'error');
                    return;
                }
                
                // Get selected sizes
                const sizes = [];
                for (let i = 6; i <= 12; i++) {
                    const checkbox = document.getElementById(`size${i}`);
                    if (checkbox && checkbox.checked) {
                        sizes.push(i.toString());
                    }
                }
                
                if (sizes.length === 0) {
                    showAlert('Please select at least one size!', 'error');
                    return;
                }

                const productData = {
                    name,
                    category,
                    price,
                    description: description || '',
                    sizes,
                    inStock,
                    createdAt: new Date().toISOString()
                };

                console.log('Product data to save:', productData);
                showAlert('Adding product...', 'success');

                try {
                    // Try Firebase first
                    const result = await firebaseRequest('/products', 'POST', productData);
                    console.log('Firebase result:', result);
                    
                    if (result && result.name) {
                        showAlert('Product added successfully to Firebase!', 'success');
                        
                        // Add to local products array with Firebase ID
                        const newProduct = { id: result.name, ...productData };
                        products.push(newProduct);
                        
                        // Also save to localStorage as backup
                        const localProducts = JSON.parse(localStorage.getItem('bayosha_products') || '{}');
                        localProducts[result.name] = productData;
                        localStorage.setItem('bayosha_products', JSON.stringify(localProducts));
                        
                        closeModal('addProductModal');
                        resetForm();
                        displayProducts();
                        updateDashboardStats();
                    }
                    
                } catch (firebaseError) {
                    console.error('Firebase failed, using localStorage:', firebaseError);
                    
                    // Fallback to localStorage
                    const localId = 'local_' + Date.now();
                    const newProduct = { id: localId, ...productData };
                    
                    // Add to products array
                    products.push(newProduct);
                    
                    // Save to localStorage
                    const localProducts = JSON.parse(localStorage.getItem('bayosha_products') || '{}');
                    localProducts[localId] = productData;
                    localStorage.setItem('bayosha_products', JSON.stringify(localProducts));
                    
                    showAlert('Product saved locally (will sync when online)', 'success');
                    closeModal('addProductModal');
                    resetForm();
                    displayProducts();
                    updateDashboardStats();
                }
                
            } catch (error) {
                console.error('Error in handleAddProduct:', error);
                showAlert('Unexpected error occurred! Check console for details.', 'error');
            }
        }

        function resetForm() {
            document.getElementById('addProductForm').reset();
            
            // Reset stock toggle
            const toggle = document.getElementById('stockToggle');
            const status = document.getElementById('stockStatus');
            toggle.classList.add('active');
            status.textContent = 'In Stock';
        }

        async function refreshProducts() {
            showAlert('Refreshing products...', 'success');
            await loadProducts();
        }

        async function refreshOrders() {
            showAlert('Refreshing orders...', 'success');
            await loadOrders();
        }

        // Debug functions
        async function testFirebaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = 'Testing connection...';
            
            try {
                console.log('Testing Firebase connection...');
                
                // Test basic connectivity
                const testData = { test: true, timestamp: new Date().toISOString() };
                const result = await firebaseRequest('/test', 'PUT', testData);
                
                resultDiv.innerHTML = `
                    <div style="color: green;">
                        <strong>✓ Connection Successful!</strong><br>
                        Response: ${JSON.stringify(result)}<br>
                        Time: ${new Date().toLocaleString()}
                    </div>
                `;
                
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Connection test failed:', error);
                resultDiv.innerHTML = `
                    <div style="color: red;">
                        <strong>✗ Connection Failed!</strong><br>
                        Error: ${error.message}<br>
                        Time: ${new Date().toLocaleString()}
                    </div>
                `;
                
                updateConnectionStatus(false);
            }
        }

        function showLocalStorageData() {
            const resultDiv = document.getElementById('localStorageResult');
            
            const products = localStorage.getItem('bayosha_products');
            const orders = localStorage.getItem('bayosha_orders');
            
            resultDiv.innerHTML = `
                <div style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <h5>Products in localStorage:</h5>
                    <pre style="font-size: 12px; max-height: 200px; overflow-y: auto;">${products ? JSON.stringify(JSON.parse(products), null, 2) : 'No products found'}</pre>
                    
                    <h5>Orders in localStorage:</h5>
                    <pre style="font-size: 12px; max-height: 200px; overflow-y: auto;">${orders ? JSON.stringify(JSON.parse(orders), null, 2) : 'No orders found'}</pre>
                </div>
            `;
        }

        function clearLocalStorageData() {
            if (confirm('Are you sure you want to clear all local storage data?')) {
                localStorage.removeItem('bayosha_products');
                localStorage.removeItem('bayosha_orders');
                showAlert('Local storage data cleared!', 'success');
                showLocalStorageData();
            }
        }

        async function addTestProduct() {
            const resultDiv = document.getElementById('testProductResult');
            resultDiv.innerHTML = 'Adding test product...';
            
            const testProduct = {
                name: 'Test Product ' + Date.now(),
                category: 'men',
                price: 1500,
                description: 'This is a test product',
                sizes: ['8', '9', '10'],
                inStock: true,
                createdAt: new Date().toISOString()
            };
            
            try {
                console.log('Adding test product:', testProduct);
                
                const result = await firebaseRequest('/products', 'POST', testProduct);
                console.log('Test product result:', result);
                
                if (result && result.name) {
                    resultDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>✓ Test Product Added Successfully!</strong><br>
                            Firebase ID: ${result.name}<br>
                            Product: ${testProduct.name}<br>
                            Time: ${new Date().toLocaleString()}
                        </div>
                    `;
                    
                    // Refresh products list
                    await loadProducts();
                    
                } else {
                    throw new Error('No ID returned from Firebase');
                }
                
            } catch (error) {
                console.error('Test product failed:', error);
                resultDiv.innerHTML = `
                    <div style="color: red;">
                        <strong>✗ Test Product Failed!</strong><br>
                        Error: ${error.message}<br>
                        Time: ${new Date().toLocaleString()}
                    </div>
                `;
            }
        }

        // Additional utility functions
        async function toggleProductStock(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.inStock = !product.inStock;
                
                try {
                    const result = await firebaseRequest(`/products/${productId}`, 'PUT', product);
                    showAlert('Stock status updated!', 'success');
                    displayProducts();
                } catch (error) {
                    showAlert('Error updating stock!', 'error');
                    product.inStock = !product.inStock; // Revert on error
                }
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await firebaseRequest(`/products/${productId}`, 'DELETE');
                    showAlert('Product deleted successfully!', 'success');
                    await loadProducts();
                } catch (error) {
                    showAlert('Error deleting product!', 'error');
                }
            }
        }

        function editProduct(productId) {
            showAlert('Edit functionality will be implemented soon!', 'success');
        }

        function viewOrderDetails(orderId) {
            showAlert('Order details functionality will be implemented soon!', 'success');
        }

        async function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                order.updatedAt = new Date().toISOString();
                
                try {
                    await firebaseRequest(`/orders/${orderId}`, 'PUT', order);
                    showAlert('Order status updated!', 'success');
                    updateDashboardStats();
                } catch (error) {
                    showAlert('Error updating order!', 'error');
                }
            }
        }

        // Check network status
        window.addEventListener('online', () => {
            showAlert('Back online! Attempting to sync...', 'success');
            checkConnectionStatus();
        });

        window.addEventListener('offline', () => {
            showAlert('Gone offline! Using local storage.', 'error');
            updateConnectionStatus(false);
        });

        // Periodic connection check
        setInterval(checkConnectionStatus, 30000); // Check every 30 seconds