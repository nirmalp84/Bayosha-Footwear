<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayosha Footwear Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        /* Dashboard Styles */
        .admin-panel {
            display: none;
            min-height: 100vh;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .admin-body {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: #34495e;
            color: white;
            padding: 20px 0;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar li:hover {
            background: #2c3e50;
        }

        .sidebar li.active {
            background: #3498db;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background: #ecf0f1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            color: #3498db;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .size-checkboxes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .size-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::before {
            transform: translateX(30px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter input, .search-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            position: relative;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        .whatsapp-btn {
            background: #25d366;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Enhanced styles for better size display */
        .sizes-display {
            max-width: 150px;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .quick-filters {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .village-analytics {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .admin-body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media print {
            .sidebar, .admin-header, .search-filter, .btn { display: none !important; }
            .main-content { margin: 0; padding: 0; }
            .section { box-shadow: none; }
            table { page-break-inside: avoid; }
            .stat-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <form class="login-form" id="loginForm">
            <h2>Bayosha Footwear Admin</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn">Login</button>
            <div id="loginError" class="alert alert-error" style="display: none; margin-top: 15px;"></div>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <header class="admin-header">
            <h1>Bayosha Footwear Admin Panel</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="admin-body">
            <nav class="sidebar">
                <ul>
                    <li class="nav-item active" data-section="dashboard">📊 Dashboard</li>
                    <li class="nav-item" data-section="products">👟 Products Management</li>
                    <li class="nav-item" data-section="orders">📦 Orders Management</li>
                    <li class="nav-item" data-section="categories">📂 Categories</li>
                    <li class="nav-item" data-section="stock">📋 Stock Management</li>
                </ul>
            </nav>

            <main class="main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <h2>Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalProducts">0</h3>
                            <p>Total Products</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="ordersToday">0</h3>
                            <p>Orders Today</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingOrders">0</h3>
                            <p>Pending Orders</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalRevenue">₹0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <!-- Products Management Section -->
                <div id="products" class="section">
                    <h2>Products Management</h2>
                    
                    <div class="search-filter">
                        <input type="text" id="productSearch" placeholder="Search products...">
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="men">Men's</option>
                            <option value="women">Women's</option>
                            <option value="children">Children's</option>
                        </select>
                        <button class="btn" onclick="showAddProductForm()">Add New Product</button>
                    </div>

                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price (₹)</th>
                                    <th>Stock Status</th>
                                    <th>Sizes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Management Section -->
                <div id="orders" class="section">
                    <h2>Orders Management</h2>
                    
                    <div class="search-filter">
                        <input type="text" id="orderSearch" placeholder="Search orders...">
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="dateFilter">
                        <button class="btn" onclick="exportOrdersCSV()">Export CSV</button>
                    </div>

                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Village</th>
                                    <th>Date</th>
                                    <th>Amount (₹)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Categories Management Section -->
                <div id="categories" class="section">
                    <h2>Categories Management</h2>
                    
                    <div class="form-row">
                        <div>
                            <h3>Add New Category</h3>
                            <div class="form-group">
                                <label>Category Name</label>
                                <input type="text" id="newCategoryName" placeholder="Enter category name">
                            </div>
                            <button class="btn" onclick="addCategory()">Add Category</button>
                        </div>
                        <div>
                            <h3>Add Subcategory</h3>
                            <div class="form-group">
                                <label>Parent Category</label>
                                <select id="parentCategory">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Subcategory Name</label>
                                <input type="text" id="newSubcategoryName" placeholder="Enter subcategory name">
                            </div>
                            <button class="btn" onclick="addSubcategory()">Add Subcategory</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="categoriesTable">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Subcategories</th>
                                    <th>Products Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Management Section -->
                <div id="stock" class="section">
                    <h2>Stock Management</h2>
                    
                    <div class="search-filter">
                        <select id="stockFilter">
                            <option value="">All Products</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                        </select>
                        <button class="btn" onclick="bulkStockUpdate()">Bulk Update</button>
                    </div>

                    <div class="table-container">
                        <table id="stockTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Current Stock</th>
                                    <th>Available Sizes</th>
                                    <th>Quick Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stockTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addProductModal')">&times;</span>
            <h3>Add New Product</h3>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="productCategory" required onchange="updateSubcategories()">
                            <option value="">Select Category</option>
                            <option value="men">Men's</option>
                            <option value="women">Women's</option>
                            <option value="children">Children's</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Product Image URL (optional)</label>
                    <input type="text" id="productImageUrl" placeholder="Enter image URL">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="productSubcategory">
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price (₹) *</label>
                        <input type="number" id="productPrice" required min="0" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Product Image</label>
                    <input type="file" id="productImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Available Sizes</label>
                    <div class="size-checkboxes">
                        <div class="size-checkbox">
                            <input type="checkbox" id="size6" value="6">
                            <label for="size6">6</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size7" value="7">
                            <label for="size7">7</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size8" value="8">
                            <label for="size8">8</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size9" value="9">
                            <label for="size9">9</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size10" value="10">
                            <label for="size10">10</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size11" value="11">
                            <label for="size11">11</label>
                        </div>
                        <div class="size-checkbox">
                            <input type="checkbox" id="size12" value="12">
                            <label for="size12">12</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Stock Status</label>
                    <div class="toggle-switch active" id="stockToggle" onclick="toggleStock()">
                    </div>
                    <span id="stockStatus">In Stock</span>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDescription" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" class="btn">Add Product</button>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('orderDetailsModal')">&times;</span>
            <h3>Order Details</h3>
            <div id="orderDetailsContent">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('productDetailsModal')">&times;</span>
            <h3>Product Details</h3>
            <div id="productDetailsContent">
                <!-- Product details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let products = [];
        let orders = [];
        let categories = {
            men: ['Casual Shoes', 'Formal Shoes', 'Sports Shoes', 'Sandals'],
            women: ['Heels', 'Flats', 'Sandals', 'Boots', 'Sports Shoes'],
            children: ['School Shoes', 'Sports Shoes', 'Sandals', 'Boots']
        };

        // Firebase configuration
        const FIREBASE_URL = 'https://bayosa-footwear-default-rtdb.asia-southeast1.firebasedatabase.app/';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            setupEventListeners();
            loadInitialData();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    showSection(this.dataset.section);
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search and filters
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            document.getElementById('orderSearch').addEventListener('input', filterOrders);
            document.getElementById('statusFilter').addEventListener('change', filterOrders);
            document.getElementById('dateFilter').addEventListener('change', filterOrders);

            // Add product form
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Stock filter
            const stockFilter = document.getElementById('stockFilter');
            if (stockFilter) {
                stockFilter.addEventListener('change', filterStock);
            }

            // Select all functionality
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('#stockTable input[type="checkbox"][data-product-id]');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            }
        }

        // Helper function to escape HTML and prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Enhanced displayProducts function with better size handling
        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                // Enhanced sizes handling with better error checking
                let sizesDisplay = '';
                
                try {
                    if (Array.isArray(product.sizes)) {
                        // If sizes is an array
                        sizesDisplay = product.sizes.length > 0 ? product.sizes.join(', ') : 'No sizes';
                    } else if (typeof product.sizes === 'string') {
                        // If sizes is a string (could be comma-separated)
                        sizesDisplay = product.sizes.trim() || 'No sizes';
                    } else if (product.sizes && typeof product.sizes === 'object') {
                        // If sizes is an object, convert to array
                        const sizesArray = Object.keys(product.sizes).filter(key => product.sizes[key]);
                        sizesDisplay = sizesArray.length > 0 ? sizesArray.join(', ') : 'No sizes';
                    } else {
                        // Fallback for undefined, null, or other types
                        sizesDisplay = 'No sizes';
                    }
                } catch (error) {
                    console.error('Error processing sizes for product:', product.id, error);
                    sizesDisplay = 'Error loading sizes';
                }

                // Safe handling of other product properties
                const productId = product.id || 'unknown';
                const productName = product.name || 'Unnamed Product';
                const productCategory = product.category || 'Uncategorized';
                const productPrice = product.price || 0;
                const isInStock = product.inStock !== undefined ? product.inStock : false;

                return `
                    <tr>
                        <td>${productId.toString().substr(-6)}</td>
                        <td>${escapeHtml(productName)}</td>
                        <td>${escapeHtml(productCategory)}</td>
                        <td>₹${parseFloat(productPrice).toLocaleString()}</td>
                        <td>
                            <div class="toggle-switch ${isInStock ? 'active' : ''}" 
                                 onclick="toggleProductStock('${productId}')"
                                 title="Click to toggle stock status">
                            </div>
                            <span style="margin-left: 10px;">${isInStock ? 'In Stock' : 'Out of Stock'}</span>
                        </td>
                        <td>
                            <span class="sizes-display" title="${sizesDisplay}">
                                ${sizesDisplay.length > 20 ? sizesDisplay.substr(0, 20) + '...' : sizesDisplay}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" 
                                        onclick="editProduct('${productId}')"
                                        title="Edit Product">
                                    Edit
                                </button>
                                <button class="btn-small btn-delete" 
                                        onclick="deleteProduct('${productId}')"
                                        title="Delete Product">
                                    Delete
                                </button>
                                <button class="btn-small btn-view" 
                                        onclick="viewProduct('${productId}')"
                                        title="View Details">
                                    View
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Enhanced displayFilteredProducts function
        function displayFilteredProducts(filteredProducts) {
            const tbody = document.getElementById('productsTableBody');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No products match your filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredProducts.map(product => {
                // Use the same enhanced size handling logic
                let sizesDisplay = '';
                
                try {
                    if (Array.isArray(product.sizes)) {
                        sizesDisplay = product.sizes.length > 0 ? product.sizes.join(', ') : 'No sizes';
                    } else if (typeof product.sizes === 'string') {
                        sizesDisplay = product.sizes.trim() || 'No sizes';
                    } else if (product.sizes && typeof product.sizes === 'object') {
                        const sizesArray = Object.keys(product.sizes).filter(key => product.sizes[key]);
                        sizesDisplay = sizesArray.length > 0 ? sizesArray.join(', ') : 'No sizes';
                    } else {
                        sizesDisplay = 'No sizes';
                    }
                } catch (error) {
                    console.error('Error processing sizes for product:', product.id, error);
                    sizesDisplay = 'Error loading sizes';
                }

                const productId = product.id || 'unknown';
                const productName = product.name || 'Unnamed Product';
                const productCategory = product.category || 'Uncategorized';
                const productPrice = product.price || 0;
                const isInStock = product.inStock !== undefined ? product.inStock : false;

                return `
                    <tr>
                        <td>${productId.toString().substr(-6)}</td>
                        <td>${escapeHtml(productName)}</td>
                        <td>${escapeHtml(productCategory)}</td>
                        <td>₹${parseFloat(productPrice).toLocaleString()}</td>
                        <td>
                            <div class="toggle-switch ${isInStock ? 'active' : ''}" 
                                 onclick="toggleProductStock('${productId}')"
                                 title="Click to toggle stock status">
                            </div>
                            <span style="margin-left: 10px;">${isInStock ? 'In Stock' : 'Out of Stock'}</span>
                        </td>
                        <td>
                            <span class="sizes-display" title="${sizesDisplay}">
                                ${sizesDisplay.length > 20 ? sizesDisplay.substr(0, 20) + '...' : sizesDisplay}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" 
                                        onclick="editProduct('${productId}')"
                                        title="Edit Product">
                                    Edit
                                </button>
                                <button class="btn-small btn-delete" 
                                        onclick="deleteProduct('${productId}')"
                                        title="Delete Product">
                                    Delete
                                </button>
                                <button class="btn-small btn-view" 
                                        onclick="viewProduct('${productId}')"
                                        title="View Details">
                                    View
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // View product details function
        function viewProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showAlert('Product not found!', 'error');
                return;
            }

            const sizesDisplay = Array.isArray(product.sizes) ? 
                product.sizes.join(', ') : 
                (product.sizes || 'No sizes available');

            const detailsContent = `
                <div style="line-height: 1.8;">
                    <h4>Product Information</h4>
                    <p><strong>ID:</strong> ${product.id}</p>
                    <p><strong>Name:</strong> ${escapeHtml(product.name)}</p>
                    <p><strong>Category:</strong> ${escapeHtml(product.category)}</p>
                    <p><strong>Subcategory:</strong> ${escapeHtml(product.subcategory || 'Not specified')}</p>
                    <p><strong>Price:</strong> ₹${parseFloat(product.price).toLocaleString()}</p>
                    <p><strong>Stock Status:</strong> 
                        <span class="status-badge ${product.inStock ? 'status-delivered' : 'status-cancelled'}">
                            ${product.inStock ? 'In Stock' : 'Out of Stock'}
                        </span>
                    </p>
                    
                    <h4 style="margin-top: 20px;">Available Sizes</h4>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin: 10px 0;">
                        ${sizesDisplay}
                    </div>
                    
                    <h4 style="margin-top: 20px;">Description</h4>
                    <p style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ${escapeHtml(product.description || 'No description available')}
                    </p>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-small btn-edit" onclick="editProduct('${product.id}'); closeModal('productDetailsModal');">Edit Product</button>
                        <button class="btn-small btn-delete" onclick="deleteProduct('${product.id}'); closeModal('productDetailsModal');">Delete Product</button>
                    </div>
                </div>
            `;
            
            document.getElementById('productDetailsContent').innerHTML = detailsContent;
            document.getElementById('productDetailsModal').style.display = 'block';
        }

        // Initialize sample data if no data exists
        function initializeSampleData() {
            // Check if we have any data
            const hasProducts = products.length > 0;
            const hasOrders = orders.length > 0;
            
            if (!hasProducts) {
                // Add sample products to localStorage
                const sampleProducts = {
                    'sample1': {
                        name: 'Classic Black Formal Shoes',
                        category: 'men',
                        subcategory: 'formal-shoes',
                        price: 2500,
                        sizes: ['7', '8', '9', '10'],
                        inStock: true,
                        description: 'Premium quality black formal shoes for men',
                        createdAt: new Date().toISOString()
                    },
                    'sample2': {
                        name: 'Women\'s Red Heels',
                        category: 'women',
                        subcategory: 'heels',
                        price: 1800,
                        sizes: ['6', '7', '8'],
                        inStock: true,
                        description: 'Elegant red heels for special occasions',
                        createdAt: new Date().toISOString()
                    },
                    'sample3': {
                        name: 'Kids Sports Shoes',
                        category: 'children',
                        subcategory: 'sports-shoes',
                        price: 1200,
                        sizes: ['6', '7', '8', '9'],
                        inStock: false,
                        description: 'Comfortable sports shoes for active kids',
                        createdAt: new Date().toISOString()
                    }
                };
                
                localStorage.setItem('bayosha_products', JSON.stringify(sampleProducts));
                console.log('Sample products initialized');
            }
            
            if (!hasOrders) {
                // Add sample orders to localStorage
                const sampleOrders = {
                    'sample_order1': {
                        customerName: 'Rajesh Kumar',
                        phone: '9876543210',
                        village: 'Malviya Nagar',
                        address: 'House No. 123, Malviya Nagar, Jaipur',
                        date: new Date().toISOString(),
                        status: 'pending',
                        total: 2500,
                        items: [
                            { name: 'Classic Black Formal Shoes', size: '9', quantity: 1, price: 2500 }
                        ]
                    },
                    'sample_order2': {
                        customerName: 'Priya Sharma',
                        phone: '9876543211',
                        village: 'Vaishali Nagar',
                        address: 'B-45, Vaishali Nagar, Jaipur',
                        date: new Date(Date.now() - 86400000).toISOString(),
                        status: 'delivered',
                        total: 1800,
                        items: [
                            { name: 'Women\'s Red Heels', size: '7', quantity: 1, price: 1800 }
                        ]
                    }
                };
                
                localStorage.setItem('bayosha_orders', JSON.stringify(sampleOrders));
                console.log('Sample orders initialized');
            }
        }

        function checkSession() {
            const rememberedUser = localStorage.getItem('adminUser');
            if (rememberedUser) {
                currentUser = JSON.parse(rememberedUser);
                showAdminPanel();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (username === 'admin' && password === 'bayosha123') {
                currentUser = { username, loginTime: new Date().toISOString() };
                
                if (rememberMe) {
                    localStorage.setItem('adminUser', JSON.stringify(currentUser));
                }
                
                showAdminPanel();
                showAlert('Login successful!', 'success');
            } else {
                showAlert('Invalid credentials!', 'error');
            }
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboardData();
            loadProducts();
            loadOrders();
        }

        function logout() {
            localStorage.removeItem('adminUser');
            currentUser = null;
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            switch(sectionId) {
                case 'stock':
                    displayStockManagement();
                    break;
                case 'categories':
                    displayCategories();
                    break;
                case 'dashboard':
                    createSalesChart();
                    enhanceDashboard();
                    break;
                case 'orders':
                    if (!document.querySelector('.quick-filters')) {
                        createAdvancedOrderFilters();
                    }
                    break;
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Firebase API functions with improved error handling and fallback
        async function firebaseGet(endpoint) {
            try {
                // Add CORS headers and better error handling
                const response = await fetch(`${FIREBASE_URL}${endpoint}.json`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Firebase GET error:', error);
                showAlert(`Connection error: Using offline mode`, 'error');
                // Return local mock data as fallback
                return getLocalMockData(endpoint);
            }
        }

        async function firebasePost(endpoint, data) {
            try {
                const response = await fetch(`${FIREBASE_URL}${endpoint}.json`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data),
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Firebase POST error:', error);
                showAlert('Connection error: Data saved locally', 'error');
                // Save to local storage as fallback
                return saveToLocalStorage(endpoint, data);
            }
        }

        async function firebasePut(endpoint, data) {
            try {
                const response = await fetch(`${FIREBASE_URL}${endpoint}.json`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data),
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Firebase PUT error:', error);
                showAlert('Connection error: Changes saved locally', 'error');
                return updateLocalStorage(endpoint, data);
            }
        }

        async function firebaseDelete(endpoint) {
            try {
                const response = await fetch(`${FIREBASE_URL}${endpoint}.json`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return true;
            } catch (error) {
                console.error('Firebase DELETE error:', error);
                showAlert('Connection error: Item marked for deletion locally', 'error');
                return deleteFromLocalStorage(endpoint);
            }
        }

        // Local storage fallback functions
        function getLocalMockData(endpoint) {
            const localData = localStorage.getItem('bayosha_' + endpoint.replace('/', ''));
            if (localData) {
                return JSON.parse(localData);
            }
            
            // Return mock data if no local data exists
            if (endpoint === '/products') {
                return {
                    'prod1': {
                        name: 'Classic Black Formal Shoes',
                        category: 'men',
                        subcategory: 'formal-shoes',
                        price: 2500,
                        sizes: ['7', '8', '9', '10'],
                        inStock: true,
                        description: 'Premium quality black formal shoes for men'
                    },
                    'prod2': {
                        name: 'Women\'s Red Heels',
                        category: 'women',
                        subcategory: 'heels',
                        price: 1800,
                        sizes: ['6', '7', '8'],
                        inStock: true,
                        description: 'Elegant red heels for special occasions'
                    },
                    'prod3': {
                        name: 'Kids Sports Shoes',
                        category: 'children',
                        subcategory: 'sports-shoes',
                        price: 1200,
                        sizes: ['6', '7', '8', '9'],
                        inStock: false,
                        description: 'Comfortable sports shoes for active kids'
                    }
                };
            }
            
            if (endpoint === '/orders') {
                return {
                    'order1': {
                        customerName: 'Rajesh Kumar',
                        phone: '9876543210',
                        village: 'Malviya Nagar',
                        address: 'House No. 123, Malviya Nagar, Jaipur',
                        date: new Date().toISOString(),
                        status: 'pending',
                        total: 2500,
                        items: [
                            { name: 'Classic Black Formal Shoes', size: '9', quantity: 1, price: 2500 }
                        ]
                    },
                    'order2': {
                        customerName: 'Priya Sharma',
                        phone: '9876543211',
                        village: 'Vaishali Nagar',
                        address: 'B-45, Vaishali Nagar, Jaipur',
                        date: new Date(Date.now() - 86400000).toISOString(),
                        status: 'delivered',
                        total: 1800,
                        items: [
                            { name: 'Women\'s Red Heels', size: '7', quantity: 1, price: 1800 }
                        ]
                    }
                };
            }
            
            return null;
        }

        function saveToLocalStorage(endpoint, data) {
            const key = 'bayosha_' + endpoint.replace('/', '');
            const existingData = JSON.parse(localStorage.getItem(key) || '{}');
            const newId = 'local_' + Date.now();
            existingData[newId] = data;
            localStorage.setItem(key, JSON.stringify(existingData));
            return { name: newId };
        }

        function updateLocalStorage(endpoint, data) {
            const key = 'bayosha_' + endpoint.replace('/', '').split('/')[0];
            const existingData = JSON.parse(localStorage.getItem(key) || '{}');
            const id = endpoint.split('/')[1];
            if (id) {
                existingData[id] = data;
                localStorage.setItem(key, JSON.stringify(existingData));
            }
            return data;
        }

        function deleteFromLocalStorage(endpoint) {
            const key = 'bayosha_' + endpoint.replace('/', '').split('/')[0];
            const existingData = JSON.parse(localStorage.getItem(key) || '{}');
            const id = endpoint.split('/')[1];
            if (id && existingData[id]) {
                delete existingData[id];
                localStorage.setItem(key, JSON.stringify(existingData));
                return true;
            }
            return false;
        }

        // Data loading functions with better local storage integration
        async function loadInitialData() {
            await Promise.all([
                loadProducts(),
                loadOrders(),
                loadCategories()
            ]);
        }

        async function loadProducts() {
            try {
                // Try to load from Firebase first
                let data = await firebaseGet('/products');
                
                // If Firebase fails, load from localStorage
                if (!data) {
                    data = JSON.parse(localStorage.getItem('bayosha_products') || '{}');
                    console.log('Loading products from localStorage:', data);
                }
                
                // Convert object to array format
                if (data && typeof data === 'object') {
                    products = Object.entries(data).map(([id, product]) => ({
                        id, 
                        ...product
                    }));
                } else {
                    products = [];
                }
                
                console.log('Products loaded:', products);
                displayProducts();
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
                displayProducts();
            }
        }

        async function loadOrders() {
            try {
                let data = await firebaseGet('/orders');
                
                if (!data) {
                    data = JSON.parse(localStorage.getItem('bayosha_orders') || '{}');
                }
                
                if (data && typeof data === 'object') {
                    orders = Object.entries(data).map(([id, order]) => ({
                        id, 
                        ...order
                    }));
                } else {
                    orders = [];
                }
                
                console.log('Orders loaded:', orders);
                displayOrders();
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
                displayOrders();
            }
        }

        async function loadCategories() {
            try {
                let data = await firebaseGet('/categories');
                
                if (!data) {
                    data = JSON.parse(localStorage.getItem('bayosha_categories') || 'null');
                }
                
                if (data) {
                    categories = data;
                } else {
                    // Use default categories
                    categories = {
                        men: ['Casual Shoes', 'Formal Shoes', 'Sports Shoes', 'Sandals'],
                        women: ['Heels', 'Flats', 'Sandals', 'Boots', 'Sports Shoes'],
                        children: ['School Shoes', 'Sports Shoes', 'Sandals', 'Boots']
                    };
                }
                
                updateCategorySelectors();
                
            } catch (error) {
                console.error('Error loading categories:', error);
                // Use default categories on error
                categories = {
                    men: ['Casual Shoes', 'Formal Shoes', 'Sports Shoes', 'Sandals'],
                    women: ['Heels', 'Flats', 'Sandals', 'Boots', 'Sports Shoes'],
                    children: ['School Shoes', 'Sports Shoes', 'Sandals', 'Boots']
                };
                updateCategorySelectors();
            }
        }

        function loadDashboardData() {
            updateDashboardStats();
            createSalesChart();
        }

        function updateDashboardStats() {
            // Calculate stats
            const totalProducts = products.length;
            const today = new Date().toDateString();
            const ordersToday = orders.filter(order => 
                new Date(order.date).toDateString() === today
            ).length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const totalRevenue = orders
                .filter(order => order.status === 'delivered')
                .reduce((sum, order) => sum + (order.total || 0), 0);

            // Update DOM
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('ordersToday').textContent = ordersToday;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
        }

        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>#${order.id.substr(-6)}</td>
                    <td>${escapeHtml(order.customerName)}</td>
                    <td>${escapeHtml(order.village)}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>₹${parseFloat(order.total).toLocaleString()}</td>
                    <td>
                        <select onchange="updateOrderStatus('${order.id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-small btn-view" onclick="viewOrderDetails('${order.id}')">View</button>
                        <a href="https://wa.me/91${order.phone}" class="whatsapp-btn" target="_blank">WhatsApp</a>
                    </td>
                </tr>
            `).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            displayFilteredProducts(filteredProducts);
        }

        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredOrders = orders.filter(order => {
                const matchesSearch = order.customerName.toLowerCase().includes(searchTerm) || 
                                    order.village.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || order.status === statusFilter;
                const matchesDate = !dateFilter || 
                                  new Date(order.date).toDateString() === new Date(dateFilter).toDateString();
                return matchesSearch && matchesStatus && matchesDate;
            });

            displayFilteredOrders(filteredOrders);
        }

        function displayFilteredOrders(filteredOrders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td>#${order.id.substr(-6)}</td>
                    <td>${escapeHtml(order.customerName)}</td>
                    <td>${escapeHtml(order.village)}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>₹${parseFloat(order.total).toLocaleString()}</td>
                    <td>
                        <select onchange="updateOrderStatus('${order.id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-small btn-view" onclick="viewOrderDetails('${order.id}')">View</button>
                        <a href="https://wa.me/91${order.phone}" class="whatsapp-btn" target="_blank">WhatsApp</a>
                    </td>
                </tr>
            `).join('');
        }

        function showAddProductForm() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function updateSubcategories() {
            const category = document.getElementById('productCategory').value;
            const subcategorySelect = document.getElementById('productSubcategory');
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (category && categories[category]) {
                categories[category].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.toLowerCase().replace(' ', '-');
                    option.textContent = subcategory;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        function updateCategorySelectors() {
            const parentCategorySelect = document.getElementById('parentCategory');
            parentCategorySelect.innerHTML = '<option value="">Select Category</option>';
            
            Object.keys(categories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                parentCategorySelect.appendChild(option);
            });
        }

        function toggleStock() {
            const toggle = document.getElementById('stockToggle');
            const status = document.getElementById('stockStatus');
            
            if (toggle.classList.contains('active')) {
                toggle.classList.remove('active');
                status.textContent = 'Out of Stock';
            } else {
                toggle.classList.add('active');
                status.textContent = 'In Stock';
            }
        }

     async function handleAddProduct(e) {
    e.preventDefault();

    if (!validateForm('addProductForm')) {
        showAlert('Please fill all required fields!', 'error');
        return;
    }

    const name = document.getElementById('productName').value.trim();
    let category = document.getElementById('productCategory').value;
    const subcategory = document.getElementById('productSubcategory').value;
    const price = parseFloat(document.getElementById('productPrice').value);
    const description = document.getElementById('productDescription').value.trim();
    const inStock = document.getElementById('stockToggle').classList.contains('active');

    // Get selected sizes as string array and convert to numbers
    const sizesCheckboxes = [];
    for (let i = 6; i <= 12; i++) {
        const cb = document.getElementById(`size${i}`);
        if (cb && cb.checked) {
            sizesCheckboxes.push(i);
        }
    }

    if (sizesCheckboxes.length === 0) {
        showAlert('Please select at least one size!', 'error');
        return;
    }

    // Get image URL from input field
    const imageUrl = document.getElementById('productImageUrl').value.trim();

    // Normalize category for website usage
    if (category === "mens") {
       category = "men";
    }

    const productData = {
        name,
        category,
        subcategory: subcategory || '',
        originalPrice: price,
        currentPrice: price,
        discount: 0,
        rating: 4.5,
        reviewCount: 0,
        image: imageUrl || '',        // Directly use image URL or empty
        sizes: sizesCheckboxes,       // Array of numbers
        inStock,
        description: description || '',
        createdAt: new Date().toISOString()
    };

    try {
        showAlert('Adding product...', 'success');

        let result = await firebasePost('/products', productData);

        if (!result) {
            showAlert('Failed to add product. Try again.', 'error');
        } else {
            showAlert('Product added successfully!', 'success');
            closeModal('addProductModal');

            // Reset form
            document.getElementById('addProductForm').reset();
            // Reset stock toggle UI if needed
            const toggle = document.getElementById('stockToggle');
            toggle.classList.add('active');
            document.getElementById('stockStatus').textContent = 'In Stock';

            // Refresh products list and stats
            await loadProducts();
            updateDashboardStats();
        }
    } catch (error) {
        console.error('Error adding product:', error);
        showAlert('Unexpected error occurred!', 'error');
    }
}

        async function toggleProductStock(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.inStock = !product.inStock;
                const result = await firebasePut(`/products/${productId}`, product);
                
                if (result) {
                    showAlert('Stock status updated!', 'success');
                    displayProducts();
                } else {
                    showAlert('Error updating stock!', 'error');
                    product.inStock = !product.inStock; // Revert on error
                }
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                const result = await firebaseDelete(`/products/${productId}`);
                
                if (result) {
                    showAlert('Product deleted successfully!', 'success');
                    await loadProducts();
                } else {
                    showAlert('Error deleting product!', 'error');
                }
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                order.updatedAt = new Date().toISOString();
                
                const result = await firebasePut(`/orders/${orderId}`, order);
                
                if (result) {
                    showAlert('Order status updated!', 'success');
                    updateDashboardStats();
                } else {
                    showAlert('Error updating order!', 'error');
                }
            }
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const detailsContent = `
                <div style="line-height: 1.8;">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${escapeHtml(order.customerName)}</p>
                    <p><strong>Phone:</strong> ${order.phone}</p>
                    <p><strong>Village:</strong> ${escapeHtml(order.village)}</p>
                    <p><strong>Address:</strong> ${escapeHtml(order.address)}</p>
                    
                    <h4 style="margin-top: 20px;">Order Details</h4>
                    <p><strong>Order ID:</strong> #${order.id.substr(-6)}</p>
                    <p><strong>Date:</strong> ${new Date(order.date).toLocaleDateString()}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status}</span></p>
                    
                    <h4 style="margin-top: 20px;">Items Ordered</h4>
                    ${order.items ? order.items.map(item => `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                            <p><strong>${escapeHtml(item.name)}</strong></p>
                            <p>Size: ${item.size} | Quantity: ${item.quantity} | Price: ₹${item.price}</p>
                        </div>
                    `).join('') : '<p>No items found</p>'}
                    
                    <h4 style="margin-top: 20px;">Total Amount</h4>
                    <p style="font-size: 18px; font-weight: bold; color: #27ae60;">₹${parseFloat(order.total).toLocaleString()}</p>
                    
                    <div style="margin-top: 20px;">
                        <a href="https://wa.me/91${order.phone}" class="whatsapp-btn" target="_blank">Contact Customer</a>
                        <button class="btn-small btn-edit" onclick="printOrder('${order.id}')">Print Order</button>
                    </div>
                </div>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = detailsContent;
            document.getElementById('orderDetailsModal').style.display = 'block';
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Populate form with existing data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description || '';
            
            // Set sizes
            for (let i = 6; i <= 12; i++) {
                const checkbox = document.getElementById(`size${i}`);
                if (checkbox) {
                    checkbox.checked = Array.isArray(product.sizes) ? product.sizes.includes(i.toString()) : false;
                }
            }
            
            // Set stock status
            const toggle = document.getElementById('stockToggle');
            const status = document.getElementById('stockStatus');
            if (product.inStock) {
                toggle.classList.add('active');
                status.textContent = 'In Stock';
            } else {
                toggle.classList.remove('active');
                status.textContent = 'Out of Stock';
            }
            
            // Update subcategories and select current one
            updateSubcategories();
            setTimeout(() => {
                document.getElementById('productSubcategory').value = product.subcategory || '';
            }, 100);
            
            // Change form submission to update instead of create
            const form = document.getElementById('addProductForm');
            form.onsubmit = (e) => handleUpdateProduct(e, productId);
            
            document.getElementById('addProductModal').style.display = 'block';
        }

        async function handleUpdateProduct(e, productId) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const subcategory = document.getElementById('productSubcategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value;
            const inStock = document.getElementById('stockToggle').classList.contains('active');
            
            // Get selected sizes
            const sizes = [];
            for (let i = 6; i <= 12; i++) {
                if (document.getElementById(`size${i}`).checked) {
                    sizes.push(i.toString());
                }
            }

            const productData = {
                name,
                category,
                subcategory,
                price,
                description,
                sizes,
                inStock,
                updatedAt: new Date().toISOString()
            };

            const result = await firebasePut(`/products/${productId}`, productData);
            
            if (result) {
                showAlert('Product updated successfully!', 'success');
                closeModal('addProductModal');
                document.getElementById('addProductForm').reset();
                
                // Reset form to add mode
                document.getElementById('addProductForm').onsubmit = handleAddProduct;
                
                await loadProducts();
            } else {
                showAlert('Error updating product!', 'error');
            }
        }

        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            if (!categoryName) {
                showAlert('Please enter a category name!', 'error');
                return;
            }

            const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '-');
            categories[categoryKey] = [];
            
            const result = await firebasePut('/categories', categories);
            
            if (result) {
                showAlert('Category added successfully!', 'success');
                document.getElementById('newCategoryName').value = '';
                updateCategorySelectors();
                displayCategories();
            } else {
                showAlert('Error adding category!', 'error');
            }
        }

        async function addSubcategory() {
            const parentCategory = document.getElementById('parentCategory').value;
            const subcategoryName = document.getElementById('newSubcategoryName').value.trim();
            
            if (!parentCategory || !subcategoryName) {
                showAlert('Please select a category and enter subcategory name!', 'error');
                return;
            }

            if (!categories[parentCategory]) {
                categories[parentCategory] = [];
            }
            
            categories[parentCategory].push(subcategoryName);
            
            const result = await firebasePut('/categories', categories);
            
            if (result) {
                showAlert('Subcategory added successfully!', 'success');
                document.getElementById('newSubcategoryName').value = '';
                displayCategories();
            } else {
                showAlert('Error adding subcategory!', 'error');
            }
        }

        function displayCategories() {
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = Object.entries(categories).map(([category, subcategories]) => {
                const productCount = products.filter(p => p.category === category).length;
                return `
                    <tr>
                        <td>${category.charAt(0).toUpperCase() + category.slice(1)}</td>
                        <td>${subcategories.join(', ')}</td>
                        <td>${productCount}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editCategory('${category}')">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteCategory('${category}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Stock management functions
        function displayStockManagement() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = products.map(product => {
                const sizesDisplay = Array.isArray(product.sizes) ? 
                    product.sizes.join(', ') : 
                    (product.sizes || 'No sizes');

                return `
                    <tr>
                        <td><input type="checkbox" data-product-id="${product.id}"></td>
                        <td>${escapeHtml(product.name)}</td>
                        <td>${escapeHtml(product.category)}</td>
                        <td>
                            <span class="status-badge ${product.inStock ? 'status-delivered' : 'status-cancelled'}">
                                ${product.inStock ? 'In Stock' : 'Out of Stock'}
                            </span>
                        </td>
                        <td>${sizesDisplay}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="quickStockToggle('${product.id}')">
                                ${product.inStock ? 'Mark Out' : 'Mark In'}
                            </button>
                            <button class="btn-small btn-view" onclick="editProductSizes('${product.id}')">Edit Sizes</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function quickStockToggle(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.inStock = !product.inStock;
                const result = await firebasePut(`/products/${productId}`, product);
                
                if (result) {
                    showAlert('Stock status updated!', 'success');
                    displayStockManagement();
                    displayProducts();
                    updateDashboardStats();
                } else {
                    showAlert('Error updating stock!', 'error');
                    product.inStock = !product.inStock; // Revert on error
                }
            }
        }

        function editProductSizes(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const currentSizes = product.sizes || [];
            const sizesHTML = ['6', '7', '8', '9', '10', '11', '12'].map(size => 
                `<label style="display: inline-block; margin: 5px;">
                    <input type="checkbox" value="${size}" ${currentSizes.includes(size) ? 'checked' : ''}> ${size}
                </label>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>Edit Sizes for ${escapeHtml(product.name)}</h3>
                    <div style="margin: 20px 0;">
                        ${sizesHTML}
                    </div>
                    <button class="btn" onclick="updateProductSizes('${productId}', this.parentElement.parentElement)">Update Sizes</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateProductSizes(productId, modalElement) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const checkboxes = modalElement.querySelectorAll('input[type="checkbox"]:checked');
            const newSizes = Array.from(checkboxes).map(cb => cb.value);

            product.sizes = newSizes;
            product.updatedAt = new Date().toISOString();

            const result = await firebasePut(`/products/${productId}`, product);
            
            if (result) {
                showAlert('Product sizes updated!', 'success');
                modalElement.remove();
                displayStockManagement();
                displayProducts();
            } else {
                showAlert('Error updating sizes!', 'error');
            }
        }

        function bulkStockUpdate() {
            const selectedProducts = Array.from(document.querySelectorAll('#stockTable input[type="checkbox"]:checked'))
                .map(cb => cb.dataset.productId)
                .filter(id => id);

            if (selectedProducts.length === 0) {
                showAlert('Please select products to update!', 'error');
                return;
            }

            const action = prompt('Enter action: "in" for In Stock, "out" for Out of Stock');
            if (action === 'in' || action === 'out') {
                const inStock = action === 'in';
                
                selectedProducts.forEach(async (productId) => {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        product.inStock = inStock;
                        await firebasePut(`/products/${productId}`, product);
                    }
                });
                
                showAlert(`Bulk update completed for ${selectedProducts.length} products!`, 'success');
                setTimeout(() => {
                    loadProducts();
                    displayStockManagement();
                }, 1000);
            }
        }

        function filterStock() {
            const filter = document.getElementById('stockFilter').value;
            let filteredProducts = [...products];

            switch(filter) {
                case 'low':
                    // Assuming low stock means less than 5 units (simplified)
                    filteredProducts = products.filter(p => p.inStock && (p.stockQuantity || 0) < 5);
                    break;
                case 'out':
                    filteredProducts = products.filter(p => !p.inStock);
                    break;
            }

            displayFilteredStock(filteredProducts);
        }

        function displayFilteredStock(filteredProducts) {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = filteredProducts.map(product => {
                const sizesDisplay = Array.isArray(product.sizes) ? 
                    product.sizes.join(', ') : 
                    (product.sizes || 'No sizes');

                return `
                    <tr>
                        <td><input type="checkbox" data-product-id="${product.id}"></td>
                        <td>${escapeHtml(product.name)}</td>
                        <td>${escapeHtml(product.category)}</td>
                        <td>
                            <span class="status-badge ${product.inStock ? 'status-delivered' : 'status-cancelled'}">
                                ${product.inStock ? 'In Stock' : 'Out of Stock'}
                            </span>
                        </td>
                        <td>${sizesDisplay}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="quickStockToggle('${product.id}')">
                                ${product.inStock ? 'Mark Out' : 'Mark In'}
                            </button>
                            <button class="btn-small btn-view" onclick="editProductSizes('${product.id}')">Edit Sizes</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Advanced order management
        function createAdvancedOrderFilters() {
            const ordersSection = document.getElementById('orders');
            const searchFilter = ordersSection.querySelector('.search-filter');
            
            if (!searchFilter.querySelector('.quick-filters')) {
                const quickFilters = document.createElement('div');
                quickFilters.className = 'quick-filters';
                quickFilters.innerHTML = `
                    <div style="margin: 10px 0;">
                        <button class="btn-small" onclick="filterOrdersByDate('today')">Today</button>
                        <button class="btn-small" onclick="filterOrdersByDate('week')">This Week</button>
                        <button class="btn-small" onclick="filterOrdersByDate('month')">This Month</button>
                        <button class="btn-small" onclick="filterOrdersByDate('all')">All Orders</button>
                    </div>
                `;
                searchFilter.appendChild(quickFilters);
            }
        }

        function filterOrdersByDate(period) {
            const today = new Date();
            let filteredOrders = [...orders];

            switch(period) {
                case 'today':
                    filteredOrders = orders.filter(order => 
                        new Date(order.date).toDateString() === today.toDateString()
                    );
                    break;
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredOrders = orders.filter(order => 
                        new Date(order.date) >= weekAgo
                    );
                    break;
                case 'month':
                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    filteredOrders = orders.filter(order => 
                        new Date(order.date) >= monthAgo
                    );
                    break;
                case 'all':
                default:
                    filteredOrders = orders;
                    break;
            }

            displayFilteredOrders(filteredOrders);
        }

        // Village analytics
        function generateVillageAnalytics() {
            const villageStats = {};
            orders.forEach(order => {
                if (!villageStats[order.village]) {
                    villageStats[order.village] = { count: 0, revenue: 0 };
                }
                villageStats[order.village].count++;
                if (order.status === 'delivered') {
                    villageStats[order.village].revenue += order.total;
                }
            });

            return Object.entries(villageStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10); // Top 10 villages
        }

        function enhanceDashboard() {
            const villageAnalytics = generateVillageAnalytics();
            
            const dashboard = document.getElementById('dashboard');
            if (!dashboard.querySelector('.village-analytics')) {
                const analyticsHTML = `
                    <div class="village-analytics">
                        <h3>Top Villages by Revenue</h3>
                        <div style="display: grid; gap: 10px; margin-top: 15px;">
                            ${villageAnalytics.map((village, index) => `
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <span>${index + 1}. ${escapeHtml(village[0])}</span>
                                    <span><strong>₹${village[1].revenue.toLocaleString()}</strong> (${village[1].count} orders)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                const analyticsDiv = document.createElement('div');
                analyticsDiv.innerHTML = analyticsHTML;
                dashboard.appendChild(analyticsDiv);
            }
        }

        function exportOrdersCSV() {
            const csvContent = [
                ['Order ID', 'Customer', 'Village', 'Date', 'Amount', 'Status'],
                ...orders.map(order => [
                    order.id,
                    order.customerName,
                    order.village,
                    new Date(order.date).toLocaleDateString(),
                    order.total,
                    order.status
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bayosha-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Order #${order.id.substr(-6)}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .details { margin-bottom: 20px; }
                        .items { margin-top: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                        th { background: #f5f5f5; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Bayosha Footwear</h1>
                        <h2>Order Invoice</h2>
                    </div>
                    <div class="details">
                        <p><strong>Order ID:</strong> #${order.id.substr(-6)}</p>
                        <p><strong>Date:</strong> ${new Date(order.date).toLocaleDateString()}</p>
                        <p><strong>Customer:</strong> ${escapeHtml(order.customerName)}</p>
                        <p><strong>Phone:</strong> ${order.phone}</p>
                        <p><strong>Village:</strong> ${escapeHtml(order.village)}</p>
                        <p><strong>Address:</strong> ${escapeHtml(order.address)}</p>
                    </div>
                    <div class="items">
                        <table>
                            <thead>
                                <tr><th>Item</th><th>Size</th><th>Qty</th><th>Price</th></tr>
                            </thead>
                            <tbody>
                                ${order.items ? order.items.map(item => `
                                    <tr>
                                        <td>${escapeHtml(item.name)}</td>
                                        <td>${item.size}</td>
                                        <td>${item.quantity}</td>
                                        <td>₹${item.price}</td>
                                    </tr>
                                `).join('') : ''}
                            </tbody>
                        </table>
                        <h3 style="text-align: right; margin-top: 20px;">Total: ₹${parseFloat(order.total).toLocaleString()}</h3>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function createSalesChart() {
            // Simple chart using canvas
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Sample data for demonstration
            const salesData = [
                { month: 'Jan', sales: 15000 },
                { month: 'Feb', sales: 22000 },
                { month: 'Mar', sales: 18000 },
                { month: 'Apr', sales: 25000 },
                { month: 'May', sales: 30000 },
                { month: 'Jun', sales: 28000 }
            ];

            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            const padding = 50;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const maxSales = Math.max(...salesData.map(d => d.sales));
            const barWidth = chartWidth / salesData.length;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bars
            salesData.forEach((data, index) => {
                const barHeight = (data.sales / maxSales) * chartHeight;
                const x = padding + index * barWidth + barWidth * 0.1;
                const y = canvas.height - padding - barHeight;
                const width = barWidth * 0.8;

                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, width, barHeight);

                // Draw labels
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data.month, x + width/2, canvas.height - padding + 20);
                ctx.fillText('₹' + (data.sales/1000) + 'k', x + width/2, y - 10);
            });

            // Draw title
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Monthly Sales Report', canvas.width/2, 30);
        }

        // Utility functions
        function deleteCategory(categoryKey) {
            if (confirm('Are you sure you want to delete this category?')) {
                delete categories[categoryKey];
                firebasePut('/categories', categories);
                showAlert('Category deleted successfully!', 'success');
                displayCategories();
                updateCategorySelectors();
            }
        }

        function editCategory(categoryKey) {
            const newName = prompt('Enter new category name:', categoryKey);
            if (newName && newName !== categoryKey) {
                categories[newName.toLowerCase().replace(/\s+/g, '-')] = categories[categoryKey];
                delete categories[categoryKey];
                firebasePut('/categories', categories);
                showAlert('Category updated successfully!', 'success');
                displayCategories();
                updateCategorySelectors();
            }
        }

        // Form validation
        function validateForm(formId) {
            const form = document.getElementById(formId);
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#e74c3c';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e1e1e1';
                }
            });
            
            return isValid;
        }

        // Mobile optimizations
        function setupMobileOptimizations() {
            if (window.innerWidth <= 768) {
                // Collapse sidebar by default on mobile
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.style.transform = 'translateX(-100%)';
                    sidebar.style.position = 'fixed';
                    sidebar.style.zIndex = '1000';
                    sidebar.style.transition = 'transform 0.3s ease';
                    
                    // Add mobile menu toggle
                    const header = document.querySelector('.admin-header');
                    if (header && !header.querySelector('.menu-toggle')) {
                        const menuToggle = document.createElement('button');
                        menuToggle.className = 'menu-toggle';
                        menuToggle.innerHTML = '☰';
                        menuToggle.style.cssText = 'background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-right: 10px;';
                        menuToggle.onclick = () => {
                            const currentTransform = sidebar.style.transform;
                            sidebar.style.transform = currentTransform === 'translateX(0px)' ? 'translateX(-100%)' : 'translateX(0px)';
                        };
                        header.insertBefore(menuToggle, header.firstChild);
                    }
                }
            }
        }

        // Auto-logout after 30 minutes of inactivity
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                showAlert('Session expired due to inactivity', 'error');
                setTimeout(logout, 2000);
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timer on user activity
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);

        // Initialize when admin panel is shown
        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            initializeSampleData();
            loadDashboardData();
            loadProducts();
            loadOrders();
            resetInactivityTimer();
            setupMobileOptimizations();
        }

        // Auto-save functionality for forms
        function autoSaveForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData);
                    localStorage.setItem(`${formId}_autosave`, JSON.stringify(data));
                });
            });
        }

        // Load auto-saved form data
        function loadAutoSavedData(formId) {
            const savedData = localStorage.getItem(`${formId}_autosave`);
            if (savedData) {
                const data = JSON.parse(savedData);
                const form = document.getElementById(formId);
                
                Object.entries(data).forEach(([key, value]) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                });
            }
        }

        // Network connectivity check
        function checkConnectivity() {
            return navigator.onLine;
        }

        // Enhanced error handling
        function handleError(error, operation) {
            console.error(`Error in ${operation}:`, error);
            showAlert(`Error: ${operation} failed. Please try again.`, 'error');
        }

        // Product sorting functionality
        function sortProducts(column, direction = 'asc') {
            products.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (column === 'price') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            displayProducts();
        }

        // Data validation functions
        function validateProductData(data) {
            const errors = [];
            
            if (!data.name || data.name.trim().length < 2) {
                errors.push('Product name must be at least 2 characters');
            }
            
            if (!data.category) {
                errors.push('Please select a category');
            }
            
            if (!data.price || data.price <= 0) {
                errors.push('Price must be greater than 0');
            }
            
            if (!data.sizes || data.sizes.length === 0) {
                errors.push('Please select at least one size');
            }
            
            return errors;
        }

        // Initialize auto-save for forms
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                autoSaveForm('addProductForm');
            }, 1000);
        });

        // Window resize handler
        window.addEventListener('resize', setupMobileOptimizations);

        // Online/offline status
        window.addEventListener('online', function() {
            showAlert('Connection restored!', 'success');
        });

        window.addEventListener('offline', function() {
            showAlert('Working offline - changes will sync when online', 'error');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N for new product
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (document.querySelector('.section.active').id === 'products') {
                    showAddProductForm();
                }
            }
            
            // Ctrl/Cmd + S for save (if in modal)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const activeModal = document.querySelector('.modal[style*="block"]');
                if (activeModal) {
                    const form = activeModal.querySelector('form');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            }
            
            // Escape to close modal
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal[style*="block"]');
                if (activeModal) {
                    activeModal.style.display = 'none';
                }
            }
        });

        // Search functionality with debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced search with debouncing
        const debouncedProductSearch = debounce(filterProducts, 300);
        const debouncedOrderSearch = debounce(filterOrders, 300);

        // Update event listeners for search
        document.addEventListener('DOMContentLoaded', function() {
            const productSearch = document.getElementById('productSearch');
            const orderSearch = document.getElementById('orderSearch');
            
            if (productSearch) {
                productSearch.removeEventListener('input', filterProducts);
                productSearch.addEventListener('input', debouncedProductSearch);
            }
            
            if (orderSearch) {
                orderSearch.removeEventListener('input', filterOrders);
                orderSearch.addEventListener('input', debouncedOrderSearch);
            }
        });

        // Performance monitoring
        function measurePerformance(operation, func) {
            const start = performance.now();
            const result = func();
            const end = performance.now();
            console.log(`${operation} took ${end - start} milliseconds`);
            return result;
        }

        // Batch operations for better performance
        function batchUpdateProducts(updates) {
            const promises = updates.map(update => firebasePut(`/products/${update.id}`, update));
            return Promise.all(promises);
        }

        // Local storage cleanup
        function cleanupLocalStorage() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('bayosha_') && key.includes('_autosave')) {
                    const timestamp = localStorage.getItem(key + '_timestamp');
                    if (timestamp && Date.now() - parseInt(timestamp) > 7 * 24 * 60 * 60 * 1000) {
                        localStorage.removeItem(key);
                        localStorage.removeItem(key + '_timestamp');
                    }
                }
            });
        }

        // Initialize cleanup on app start
        document.addEventListener('DOMContentLoaded', function() {
            cleanupLocalStorage();
        });

        // Export/Import functionality
        function exportData() {
            const data = {
                products: products,
                orders: orders,
                categories: categories,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bayosha-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.products) products = data.products;
                    if (data.orders) orders = data.orders;
                    if (data.categories) categories = data.categories;
                    
                    // Update displays
                    displayProducts();
                    displayOrders();
                    displayCategories();
                    updateDashboardStats();
                    
                    showAlert('Data imported successfully!', 'success');
                } catch (error) {
                    showAlert('Error importing data: Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Add import/export buttons to dashboard
        function addImportExportButtons() {
            const dashboard = document.getElementById('dashboard');
            if (!dashboard.querySelector('.import-export-buttons')) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'import-export-buttons';
                buttonsDiv.innerHTML = `
                    <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h4>Data Management</h4>
                        <button class="btn-small btn-view" onclick="exportData()">Export Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this.files[0])">
                        <button class="btn-small btn-edit" onclick="document.getElementById('importFile').click()">Import Data</button>
                    </div>
                `;
                dashboard.appendChild(buttonsDiv);
            }
        }

        // Enhanced dashboard initialization
        function loadDashboardData() {
            updateDashboardStats();
            createSalesChart();
            addImportExportButtons();
        }

        console.log('Bayosha Footwear Admin Panel Loaded Successfully!');
    </script>
</body>
</html>